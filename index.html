<!DOCTYPE html>
<html>

<head>
    <link rel="shortcut icon" href="#">
    <title>Audio Engine Prototype</title>
</head>

<body>
    <button id="startBtn" onclick="startAudio()">Start</button>
    <button id="stopBtn" onclick="stopAudio()">Stop</button>
    <div>
        <section>
            <h4 style="margin-bottom: 5px; color: #888">Number of Tracks</h4>
            <p style="font-size: 0.7em; color: #999">Select either the number of tracks that are created for streaming a
                test signal from IndexedDB
                or select 'Band' to playback actual stems from a band.
                </a></p>
            <button id="track-1" onclick="changeNumTracks(1)">1</button>
            <button id="track-2" onclick="changeNumTracks(2)">2</button>
            <button id="track-9" onclick="changeNumTracks(9)">9</button>
            <button id="track-10" onclick="changeNumTracks(10)">10</button>
            <button id="track-100" onclick="changeNumTracks(100)">100</button>
            <button id="track-250" onclick="changeNumTracks(250)">250</button>
            <button id="track-1000" onclick="changeNumTracks(1000)">1000</button>
            <button id="track-band" onclick="loadTrackConfig('config.json')">Band</button>
            <!-- <button id="debug" onclick="debug()">Debug</button> -->
        </section>
        <section>
            <h4 style="margin-bottom: 5px; color: #888">Audio processing language</h4>
            <p style="font-size: 0.7em; color: #999">Select which language is used
                for the load generation.
                </a></p>
            <div>
                <input type="radio" id="choice-js" name="lang" value="js" onchange="changeProcessingLanguage('js')" />
                <label style="font-size: 0.8em;" for="choice-js">JavaScript</label>
            </div>
            <div>
                <input type="radio" id="choice-wasm" name="lang" value="wasm"
                    onchange="changeProcessingLanguage('wasm')" />
                <label style="font-size: 0.8em;" for="choice-wasm">WebAssembly (faster)</label>
            </div>
        </section>
        <section>
            <h4 style="margin-bottom: 5px; color: #888">Parameters</h4>
            <p style="font-size: 0.7em; color: #999">...</a></p>
            <div style="display: flex;flex-flow: row;align-items: center;">
                <input type="range" id="load-slider" min="0" max="50" step="1.0" value="1"
                    onchange="changeProcessingLoad()" />
                <label id="load-slider-label" style="font-size: 0.8em;text-align: center;" for="load-slider"></label>
            </div>
            <h4 style="margin-bottom: 5px; color: #888">Presets</h4>
            <p style="font-size: 0.7em; color: #999">...</a></p>
            <div>
                <button id="load-0" onclick="changeProcessingLoad(0)">0</button>
                <button id="load-1" onclick="changeProcessingLoad(1)">1</button>
                <button id="load-10" onclick="changeProcessingLoad(10)">10</button>
                <button id="load-25" onclick="changeProcessingLoad(25)">25</button>
                <button id="load-50" onclick="changeProcessingLoad(50)">50</button>
            </div>
        </section>
        <script>
            exports = {};
        </script>
        <script src="utils.js"></script>
        <script src="js/index.js"></script>
        <script src="js/engine.js"></script>
        <script src="js/audiostore.js"></script>
        <script>
            const audioEngine = new AudioEngine();

            document.getElementById("startBtn").disabled = true;

            function createTrackConfig(nTracks) {
                let trackConfig = {};
                trackConfig.tracks = [];

                let samplePos = 0;
                let length = 1323000;
                let iStartInFile = 0;
                let iEndInFile = 1323000;
                for (let iTrack = 0; iTrack < nTracks; iTrack++) {
                    let track = {};

                    track.id = iTrack;
                    track.number = iTrack + 1;
                    track.lastClipIndex = 0;
                    track.clips = [];

                    let clip = {};
                    clip.fileName = "audio/sweep.wav";
                    clip.samplePos = samplePos;
                    clip.length = length;
                    clip.iStartInFile = iStartInFile;
                    clip.iEndInFile = iEndInFile;

                    track.clips.push(clip);
                    trackConfig.tracks.push(track);
                }

                return trackConfig;
            }

            function changeNumTracks(nTracks) {
                const trackModel = createTrackConfig(nTracks);
                audioEngine.setupAudioRoutingGraph(trackModel);
            }

            function changeProcessingLanguage(language) {
                window.language = language;
                const newUrl = `${window.location.origin}${window.location.pathname}?strings=${window.numStrings}&visualize=${window.visualize}&channel=${window.channel}&ratio=${window.ratio}&lang=${window.language}`;
                window.location.href = newUrl;
            }

            function changeProcessingLoad(newLoad = -1) {
                audioEngine.changeProcessingLoad(newLoad);
            }

            function debug() {
                // worker.postMessage({ command: "preload debug" });
            }

            function startAudio() {
                audioEngine.startAudio();
            }

            function stopAudio() {
                audioEngine.stopAudio();
            }

            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang') === "js"
                ? "js"
                : "wasm"

            window.language = lang;
            switch (lang) {
                case "wasm": document.getElementById("choice-wasm").checked = true; break;
                case "js": document.getElementById("choice-js").checked = true; break;
            }

            document.getElementById("load-slider-label").innerHTML = "Load: 0";
        </script>
</body>

</html>